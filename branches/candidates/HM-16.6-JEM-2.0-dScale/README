In the code, changes are under macros starting with   SHARP_


(1) Code for luma adaptive QP alone are under

#define SHARP_LUMA_DELTA_QP                1            ///< enable luma adaptive QP
#define SHARP_LUMA_RES_SCALING             0            ///< enable coefficient scaling based on luma predciton and DC 

This is the luma adaptive QP technology used in MPEG-HDR anchor3.2. QP is explicitly signalled by delta QP
Refer JCTVC-W0054 for details.


(2) Code for luma adaptive coefficient scaling are under
#define SHARP_LUMA_DELTA_QP                1            ///< enable luma adaptive QP
#define SHARP_LUMA_RES_SCALING             1            ///< enable coefficient scaling based on luma predciton and DC 

Here the target QP for each block is similar to the adaptive QP approach, But the delta QP is not signalled. Luma AC and Chroma coefficients are scaled based on reconstructed pixel. 
Refer JVET-B0054 for details.

The delta QP flag is set in in TEncTop.cpp around Ln #944  // dQP flag control
When only SHARP_LUMA_DELTA_QP is enabled, bUseDQP is set true () , so delta QP is sent. 
When SHARP_LUMA_RES_SCALING is also enabled, bUseDQP is not set, so no deltaQP is sent. ( It can still enable deltaQP signalling, just all the deltaQP signalled would be 0).


(3) Below are example config parameters to control the luma adaptive QP and scaling, in the config files:


### sample config to enable luma adaptive coefficient scaling

LumaDeltaQP                   : 2           # Luma activity based deltaQP control  -- 0: disabled  1: send dQP, 2: coefficient scaling



### sample config to enable luma adaptive delta QP at CTU level

LumaDeltaQP                   : 1           # Luma activity based deltaQP control  -- 0: disabled  1: send dQP, 2: coefficient scaling


### sample config to enable luma adaptive delta QP at CU level

LumaDeltaQP                   : 1           # Luma activity based deltaQP control  -- 0: disabled  1: send dQP, 2: coefficient scaling
MaxCuDQPDepth                 : 5           # Max depth of delta QP, should be less than MaxPartitionDepth



